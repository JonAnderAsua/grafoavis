<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Network</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script type="./js/edges.js"></script>
    <script type="module">
			import * as d3 from "https://cdn.skypack.dev/d3-sparql";
			import Node from './js/nodes.js';
			import {getType,getLabel,getComment,getGuztia} from './js/db.js'

    	var arrayNodes = [];
    	var arrayEdges = [];
    	var arrayLabels = [];

    	var arrayNodesObject = [];

    	//d3.sparql(uri, eskaera).then((data) => { //Tripleak graphdbtik atera
    	getGuztia().then((data) => {
    		var i = 0;
    		var iSubjektua = 0;
    		var iObjektua = 0;
  			data.forEach(function(triple,index){

  				var subjektua = "";
  				var predikatua = "";
  				var objektua = "";

					if(!triple["p"].includes("https://schema.org/") && !triple["p"].includes("http://www.w3.org/1999/02/22-rdf-syntax-ns#type") && !triple["p"].includes("http://www.w3.org/2000/01/rdf-schema#label") && !triple["p"].includes("http://www.w3.org/2000/01/rdf-schema#comment") && !triple["o"].includes("http://proton.semanticweb.org/protonsys#transitiveOver")){

					  //Triplearen subjektua kudeatu
					  //if(!arrayLabels.includes(triple["s"]) && triple["s"].includes("http")){
					  	getNode(triple["s"],i).then((data) => {
					  		subjektua = data;
							  if(!arrayNodes.includes(data)){
							  	i++;
							  	arrayNodes.push(data);
							  	arrayLabels.push(triple["s"]);
							  	iSubjektua = i;
							  }
							  else{
							  	iSubjektua = getIndex(triple["s"],arrayNodes);
							  } 
					 		}).then(() => {
					 			getNode(triple["o"],i).then((data) => {
					 				objektua = data;
						  		iObjektua = i;
								  if(!arrayNodes.includes(data)){
					  				i++;
									  arrayNodes.push(data);
									  arrayLabels.push(triple["o"]);
					  			}
								  else{
								  	iObjektua = getIndex(triple["o"],arrayNodes);
								  }
					 			}).then(() => {
					 				predikatua = {from:subjektua.id,to:predikatua.id,label:triple["p"]};
					 				arrayEdges.push(predikatua);
					 			})
					 		})

					 }
					})
	   	}).then(() => { //Grafoa eraiki
	   		var nodes = new vis.DataSet(arrayNodes);
				var edges = new vis.DataSet(arrayEdges);

				// create a network
		    var container = document.getElementById("mynetwork");

		    var options = {
		    	autoResize: true,
  				height: '100%',
  				width: '100%',
   				physics: {
    				enabled: false
   				}
				};

		    var data = {
		      nodes: nodes,
		      edges: edges,
		    };
		    var network = new vis.Network(container, data, options);
	   	})

	   	function getNode(uri,i){
		  	var type = "";
				var label = "";
				var comment = "";
				var emaitza = "";
				return getType(uri)
					.then(function(data) {
						type = data;
						return getLabel(uri);
					})
					.then(function(data) {
						label = data;
						return getComment(uri);
					})
					.then((data) => {
						var subjektua = new Node(uri,type,label,data,i);
						return subjektua;
					})
		  }

	   	function getIndex(subObjektua,array){
		    	var emaitza = arrayNodes.find(x => x.uri === subObjektua);
		    	return emaitza.id;
		  }

		</script>
    <style type="text/css">
      #mynetwork {
        width: 1000px;
        height: 1000px;
        border: 1px solid lightgray;
      }
    </style>
  </head>
  <body>
    <div id="mynetwork"></div>
  </body>
</html>