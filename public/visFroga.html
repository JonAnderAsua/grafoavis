<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Network</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script type="./js/edges.js"></script>
    <script type="module">
			import * as d3 from "https://cdn.skypack.dev/d3-sparql";
			import Node from './js/nodes.js'
			//https://cdn.skypack.dev/d3-sparql
    	var eskaera = "SELECT ?s ?o ?p WHERE {?s ?o ?p}"
    	var uri = "http://jonander:7200/repositories/LaDonacion"

    	var arrayNodes = [];
    	var arrayEdges = [];
    	var arrayLabels = [];

    	var arrayNodesObject = [];

    	d3.sparql(uri, eskaera).then((data) => { //Tripleak graphdbtik atera

    		var i = 1;
    		var iSubjektua = 0;
    		var iObjektua = 0;
  			data.forEach(function(triple,index){



					if(!triple["o"].includes("https://schema.org/") && !triple["o"].includes("http://www.w3.org/1999/02/22-rdf-syntax-ns#type") && !triple["o"].includes("http://www.w3.org/2000/01/rdf-schema#label") && !triple["o"].includes("http://www.w3.org/2000/01/rdf-schema#comment") && !triple["o"].includes("http://proton.semanticweb.org/protonsys#transitiveOver")){

					  //Triplearen subjektua kudeatu
					  if(!arrayLabels.includes(triple["s"])){
					  	getNode(triple["s"],i).then((data) => {
					  		iSubjektua = i;
							  i++;
							  arrayNodes.push(data);
							  arrayLabels.push(triple["s"]);
					 		})				
					  }
					  else{
					  	iSubjektua = getIndex(triple["s"],arrayNodes);
					  }


					  i++;
					 	//Triplearen objektua kudeatu
					 	if(!arrayLabels.includes(triple["p"])){
					  	getNode(triple["p"],i).then((data) => {
					  		iObjektua = i;
							  i++;
							  arrayNodes.push(data);
							  arrayLabels.push(triple["p"]);
					 		})				
					  }
					  else{
					  	iObjektua = getIndex(triple["p"],arrayNodes);
					  }


					  //Triplearen predikatua kudeatu
					  var predikatua = {from:iSubjektua,to:iObjektua,label:triple["o"]};
							arrayEdges.push(predikatua);
	  				}
	  						
  			})
	   	}).then(() => { //Grafoa eraiki
	   		var nodes = new vis.DataSet(arrayNodes);
				var edges = new vis.DataSet(arrayEdges);

				// create a network
		    var container = document.getElementById("mynetwork");

		    var options = {
		    	autoResize: true,
  				height: '100%',
  				width: '100%',
   				physics: {
    				enabled: false
   				}
				};

		    var data = {
		      nodes: nodes,
		      edges: edges,
		    };
		    var network = new vis.Network(container, data, options);
	   	})

	   	function getNode(uri,i){
		  	var type = "";
				var label = "";
				var comment = "";
				var emaitza = "";

				return getType(uri)
					.then(function(data) {
						type = data;
						return getLabel(uri);
					})
					.then(function(data) {
						label = data;
						return getComment(uri);
					})
					.then((data) => {
						var subjektua = new Node(uri,type,label,data,i);
						return subjektua;
					})
		  }

	   	function getIndex(subObjektua,array){
		    	var emaitza = arrayNodes.find(x => x.label === subObjektua);
		    	return emaitza.id;
		  }

		  function getType(uriObjektua){
		  	var eskaeraType = `
		  	PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
		  	SELECT ?type
		  	WHERE{
		  		<`+uriObjektua+`> rdf:type ?type .
		  	}`

		  	return d3.sparql(uri, eskaeraType).then((data) => {
		  		if(data.length > 0){
			  		return data[0]['type'];
		  		}
		  		else{
		  			return "Ez dauka typeik";
		  		}
		  	});

		  }

		  function getLabel(uriObjektua){
		  	var eskaeraType = `
		  	PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
		  	SELECT ?label
		  	WHERE{
		  		<`+uriObjektua+`> rdfs:label ?label .
		  	}`

		  	return d3.sparql(uri, eskaeraType).then((data) => {
		  		if(data.length > 0){
			  		return data[0]['label'];
		  		}
		  		else{
		  			return "Ez dauka labelik";
		  		}
		  	});

		  }

		  function getComment(uriObjektua){
		  	var eskaeraType = `
		  	PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
		  	SELECT ?comment
		  	WHERE{
		  		<`+uriObjektua+`> rdfs:comment ?comment .
		  	}`

		  	return d3.sparql(uri, eskaeraType).then((data) => {
		  		if(data.length > 0){
			  		return data[0]['comment'];
		  		}
		  		else{
		  			return "Ez dauka komentariorik";
		  		}
		  	});
		  }

		</script>
    <style type="text/css">
      #mynetwork {
        width: 1000px;
        height: 1000px;
        border: 1px solid lightgray;
      }
    </style>
  </head>
  <body>
    <div id="mynetwork"></div>
  </body>
</html>