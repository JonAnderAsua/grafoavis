<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Network</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script type="module">
		//Liburutegien importazioa
		import {getType,getLabel,getComment,getGuztia,getImage} from './js/db.js'
        import * as d3 from "https://cdn.skypack.dev/d3-sparql";

        //d3.select("p").text("Froga")

    	var arrayEdges = []; //Vis onartzen dituen ertzak gordetzen ditu
    	var arrayNodes = []; //Vis onartzen dituen nodoak gordetzen ditu
        var arrayLabels = []; //Labelak gordetzeko arraya

        var i = 0;
        var txibatoa = false;

		aFuncionar();
    	
        async function aFuncionar() {
            getGuztia().then((data) => {
                for(var j = 0 ; j < data.length ; j++){
                    kudeatuTriplea(data[j],data.length);
                }
            })

        }

        async function kudeatuTriplea(triple,luzera){

          var erlazioa = getErlazioa(triple['p'])

          if(erlazioa !== 'Aipatu') {

            //Subjektua kudeatu
            var iSubj = await kudeatuNodoak(triple['s'], i);

            //Objektua kudeatu
            var iObj = await kudeatuNodoak(triple['o'], i)

            //Predikatua kudeatu
            var predikatua = {from: iSubj, to: iObj, label: erlazioa};
            arrayEdges.push(predikatua);

            console.log(i)

            if (i >= 207 & !txibatoa) { //Pixkat gualtrapada bat da baina horrela egin behar dut grafoa elementu guztietatik pasa ostean grafoa eraikitzeko (frogatu behar da)
              //Bider 2 egiten da triple bakoitza subjektu eta objektu elementuak dituelako
              grafoaEraiki();
              txibatoa = true;
            }
          }
        }

        function grafoaEraiki(){
            //In: -
            //Out: Grafoa

            //Zerrendak dataset bihurtu
            console.log(arrayNodes);
            console.log(arrayEdges);

            var nodes = new vis.DataSet(arrayNodes);
			var edges = new vis.DataSet(arrayEdges);

			// Sarea sortu
		    var container = document.getElementById("mynetwork");
		    var options = {
		    	autoResize: true,
  				height: '100%',
  				width: '100%',
   				physics: {
    				enabled: false,
                    repulsion: {
                       nodeDistance: 400 // Put more distance between the nodes.
                    }
   				},
                layout: { 
                    improvedLayout: false 
                }
			};

		    var data = {
		      nodes: nodes,
		      edges: edges,
		    };
            
		    var network = new vis.Network(container, data, options);

            network.stabilize();
        }

		async function kudeatuNodoak(izena){ //Subjektua eta objektua nodo bihurtu (igual hay que hacerla async)
            //In: Elementu baten URIa eta identifikatzaile zenbaki bat
            //Out: Elementu hori zerrenda batean gorde eha haren identifikatzailea bueltatzen du

			var labelIzena = await getLabel(izena) //Lo separo pero me imagino que se podrÃ¡ poner abajo

            if(!arrayLabels.includes(labelIzena)){ //Nodo berri bat agertzen bada
              arrayLabels.push(labelIzena)
              i++;
              //var nodoa = {id:i,label:labelIzena,shape:"circularImage",image: await getImage(labelIzena)}
              var nodoa = {id:i,label:labelIzena}
              arrayNodes.push(nodoa);
              return i;
            }
            else{ //Nodoa kudeatu bada haren identifikatzailea bueltatzen du
                return getIndex(labelIzena);
            }
		}

	   	function getIndex(subObjektua){ //Nodo jakin baten id-a atera
            //In: Elementu bat
            //Out: Elementu hori arrayNodes zerrendan bilatzen eta haren identifikaitzailea bueltatzen du

            var emaitza = "" //Honela hasieratzen da 'por si las moscas'
		    emaitza = arrayNodes.find(x => x.label === subObjektua);
		    return emaitza.id;
		}

        function getErlazioa(predikatua){ //Predikatuaren URIa erlazio string bat bihurtzeko
            //In: Predikatuaren URIa
            //Out: Predikatu horren erlazioa euskaraz


            var erlazioa = predikatua.split('/')[predikatua.split('/').length-1] //https://developer.mozilla.org/es/docs/Web/JavaScript/Reference/Global_Objects/String/split

            if(erlazioa.includes('#')){
                erlazioa = erlazioa.split('#')[1];
            }
            
            var emaitza = ''

            switch(erlazioa){ //https://developer.mozilla.org/es/docs/Web/JavaScript/Reference/Statements/switch
                case 'parent':
                    emaitza = 'Gurasoa';
                    break;
                case 'sibling':
                    emaitza = 'Anaia/Arreba';
                    break;
                case 'related_to':
                    emaitza = 'Familiartekoa';
                    break;
                case 'spouse':
                    emaitza = 'Senar/Emaztea';
                    break;
                case 'partner':
                    emaitza = 'Bikotea';
                    break;
                case 'knows':
                    emaitza = 'Ezaguna';
                    break;
                case 'controlls':
                    emaitza = 'Kontrolatzen du';
                    break;
                case 'manages':
                    emaitza = 'Kudeatzailea';
                    break;
                case 'represents':
                    emaitza = 'Errepresentatzen du';
                    break;
                case 'beneficiary_of':
                    emaitza = 'Onuraduna';
                    break;
                case 'has_bank_account_in': 
                    emaitza = 'Banku kontuarekin';
                    break;
                case 'worksFor': 
                    emaitza = 'Langilea';
                    break;
                case 'pays':
                    emaitza = 'Ordaintzen du';
                    break;
                case 'part_of' || 'member_of' || 'takes_part':
                    emaitza = 'Partaidea';
                    break;
                case 'registered_in':
                    emaitza = 'Erregistratuta';
                    break;
                case 'owns': 
                    emaitza = 'Jabea';
                    break;
                case 'gives':
                    emaitza = 'Emaile';
                    break;
                case 'author':
                    emaitza = 'Egilea';
                    break;
                case 'mentions':
                    emaitza = 'Aipatu';
                    break;
                case 'participant':
                    emaitza = 'Partaidea';
                    break;
                default: //happens_in
                    emaitza = 'Gertatzen da'
                    break;
            }
            return emaitza;
        }
	</script>
    <style type="text/css">
      #mynetwork {
        width: 1000px;
        height: 1000px;
        border: 1px solid lightgray;
      }
    </style>
  </head>
  <body>
    <div id="mynetwork"></div>
    <p></p>
  </body>
</html>